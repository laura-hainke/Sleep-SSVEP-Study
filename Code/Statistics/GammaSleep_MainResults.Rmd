---
title: "GammaSleep Results"
author: "L. Hainke, J. Dowsett, M. Spitschan, J. Priller"
date: '`r Sys.Date()`'
mainfont: Arial
output:
  html_document:
    code_folding: hide
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, fig.height=4.5, fig.width=7, fig.align="left")
```

```{r Environment Setup, warning=FALSE, message=FALSE}
# Working directory
setwd("C:\\Users\\Mitarbeiter\\Documents\\Gamma_Sleep\\Github_Repo\\Gamma-Sleep\\Code\\Statistics")

# Function files in current directory
source("GammaSleep_statistics_functions.r")
source("GammaSleep_data-handling_functions.r")

# Libraries
library(chron)
library(ggplot2)
library(tidyr)
library(dplyr)
library(reshape2)
library(scales)
library(see)

# For plots
colour_scheme=data.frame(con="#708090",
                         exp="#8f2d56",
                         W="#C9CC00",
                         N1="#97D1F4",
                         N2="#74BBE8",
                         N3="#2B8DCA",
                         REM="#158774")

nr_datapoints_SSVEP = 25 # 25 ms segments
nr_conditions = 2 # control, experimental
nr_stages = 4 # W, N2, N3, REM (N1 not included)
base_size = 7 # base size of plot text


## Global variables
# Using global environment (<<- assignment) to avoid redundant function arguments

# Path to folders with derivative data
path_derivatives <<- "C:\\Users\\Mitarbeiter\\Documents\\Gamma_Sleep\\Data\\Derivatives\\" 

# List of folder names in directory, corresponding to participant numbers
list_IDs <<- list.dirs(path = path_derivatives, full.names = FALSE, recursive = FALSE)

# Remove rejected datasets
list_IDs <<- list_IDs[! list_IDs %in% c("03","15")] # subjects 03 and 15 were drop-outs
```

```{r Dataframes for Derivative Data}
## Initializing 
data_demo <<- initialize_dataframe("demographic")

data_sleep <<- initialize_dataframe("sleep_quality")

data_sleep_extra <<- initialize_dataframe("sleep_supplementary")

data_PSD <<- initialize_dataframe("PSD_metrics")
                        
data_SSVEP <<- initialize_dataframe("SSVEP_metrics")

## Loading data
load_derivative_data()
```

# Sample Description

### Age

Mean = `r round(mean(data_demo$age),2)` y  
SD = `r round(sd(data_demo$age),2)` y  
Range = `r min(data_demo$age)` -- `r max(data_demo$age)` y

### Sex

`r sum(data_demo$sex=="1")` females *[1]*, `r sum(data_demo$sex=="2")` males *[2]*  
Mean = `r round(mean(data_demo$sex),2)`  
SD = `r round(sd(data_demo$sex),2)`  

### Gender

Number of participants whose indicated gender did not match their sex assigned at birth: `r sum(data_demo$gender_match=="2")`

### Handedness

`r sum(data_demo$handedness=="1")` right-handed *[1]*, `r sum(data_demo$handedness=="2")` ambidextrous *[2]*, `r sum(data_demo$handedness=="3")` left-handed *[3]*  
Mean = `r round(mean(data_demo$handedness),2)`  
SD = `r round(sd(data_demo$handedness),2)`  

### Education

Minimal possible value: "Less than secondary education (no school degree or up to 7th grade)" *[0]*  
Maximal possible value: "Doctorate or equivalent" *[7]*  
  
Mean = `r round(mean(data_demo$education),2)`  
SD = `r round(sd(data_demo$education),2)`  
Range = `r min(data_demo$education)` -- `r max(data_demo$education)`  

### Baseline Sleep Quality (PSQI)

Mean = `r round(mean(data_demo$PSQI_score),2)`  
SD = `r round(sd(data_demo$PSQI_score),2)`  
Range = `r min(data_demo$PSQI_score)` -- `r max(data_demo$PSQI_score)`

### Chronotype (uMCTQ)

Mean = `r as.character(mean(times(data_demo$uMCTQ_score)))`  
Range = `r min(data_demo$uMCTQ_score)` -- `r max(data_demo$uMCTQ_score)`  


# Confirmatory Analyses (PSD40)

## Descriptive

```{r Descriptive Table PSD40}
# Initialize
descriptive_PSD40 = data.frame(Mean_dB_con=rep(NA,4),
                               Mean_dB_exp=rep(NA,4),
                               SD_dB_con=rep(NA,4),
                               SD_dB_exp=rep(NA,4),
                               Mean_nr_epochs_con=rep(NA,4),
                               Mean_nr_epochs_exp=rep(NA,4))
stages = c("W","N2","N3","REM")
row.names(descriptive_PSD40) = stages

# Fill 
ctr_con = 3 # counter starting at column 3 of data_PSD
ctr_exp = 15 # counter starting at column 15 of data_PSD

for (s in stages) {

  descriptive_PSD40[s,"Mean_dB_con"] = round(mean(data_PSD[,ctr_con]),2)
  descriptive_PSD40[s,"Mean_dB_exp"] = round(mean(data_PSD[,ctr_exp]),2)
  descriptive_PSD40[s,"SD_dB_con"] = round(sd(data_PSD[,ctr_con]),2)
  descriptive_PSD40[s,"SD_dB_exp"] = round(sd(data_PSD[,ctr_exp]),2)
  descriptive_PSD40[s,"Mean_nr_epochs_con"] = round(mean(data_PSD[,ctr_con-1]),2)
  descriptive_PSD40[s,"Mean_nr_epochs_exp"] = round(mean(data_PSD[,ctr_exp-1]),2)
  
  ctr_con = ctr_con+3
  ctr_exp = ctr_exp+3
  
}

print(descriptive_PSD40)
```

_Table: Descriptive statistics for PSD40 across all stages and conditions. Means and standard deviations for PSD40 in dB; average number of 30 s epochs factoring into analyses._

```{r Stim Time plot}
# Conversion to long format
data_nr_epochs_long = dataframe_wide_to_long(data_PSD[,c("ID","N2_nepochs_exp","N3_nepochs_exp","REM_nepochs_exp")])
data_nr_epochs_long$value = data_nr_epochs_long$value/2 # convert nr. of epochs into minutes

ggplot(data_nr_epochs_long, aes(x=stage, y=value, fill=stage)) +
  geom_boxplot(show.legend = FALSE) + 
  geom_point(size=1, position=position_dodge(0.75)) + # add individual data points
  stat_summary(fun = "mean", geom = "point", size = 2, color = "white", position = position_dodge(0.75)) + # add mean
  annotate("segment", x=0.63, y=240, xend=1.38, yend=240, linetype="dashed", color="#899499", linewidth=0.7) + # add max. expected stimulation time for N2
  annotate("segment", x=1.63, y=96, xend=2.38, yend=96, linetype="dashed", color="#899499", linewidth=0.7) + # add max. expected stimulation time for N3
  annotate("segment", x=2.63, y=120, xend=3.38, yend=120, linetype="dashed", color="#899499", linewidth=0.7) + # add max. expected stimulation time for REM
  scale_fill_manual(values=c(colour_scheme$N2, colour_scheme$N3, colour_scheme$REM)) +
  labs(title="Stimulation Duration per Stage (Experimental)", x="Stage", y="Minutes") + # Labels
  theme_minimal(base_size = base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)), 
        panel.grid.major.x = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm"), # Plot margins
        legend.position = "none") 
```

_Figure: Stimulation duration per sleep stage across subjects, in the experimental condition. Dotted lines represent the usual time spent per night in a given stage. White dots mark mean values._

Mean duration N2: `r mean(data_nr_epochs_long$value[data_nr_epochs_long$stage == "N2"])`  
Mean duration N3: `r mean(data_nr_epochs_long$value[data_nr_epochs_long$stage == "N3"])`  
Mean duration REM: `r mean(data_nr_epochs_long$value[data_nr_epochs_long$stage == "REM"])`  

## H1a: W~exp~ > W~con~ 

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H1a normality}
check_normality(data_PSD$W_PSD40_exp - data_PSD$W_PSD40_con, plot=FALSE)
```
Outliers (con):  
```{r H1a outliers con}
check_outliers(data_PSD$W_PSD40_con, plot=FALSE)
```
Outliers (exp):  
```{r H1a outliers exp}
check_outliers(data_PSD$W_PSD40_exp, plot=FALSE)
```

### Statistical test

```{r H1a}
H1a_results = test_two_levels(data_PSD$W_PSD40_exp, data_PSD$W_PSD40_con, parametric=TRUE, alternative="greater", verbose=FALSE)
```

First, for stage W, we postulated that on average, the PSD40 value would be higher in the experimental than in the control condition (H1a). A directed paired t-test confirmed this hypothesis 
(_p_ = `r format(H1a_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_cohens_d(H1a_results[[2]])`, 
with a Cohen’s _d~z~_ of `r round(H1a_results[[2]],2)` 
(CI = [`r round(H1a_results[[3]],2)` ; `r round(H1a_results[[4]],2)`]).  

## H2a: N2~exp~ > N2~con~

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H2a normality}
check_normality(data_PSD$N2_PSD40_exp - data_PSD$N2_PSD40_con, plot=FALSE)
```
Outliers (con):  
```{r H2a outliers con}
check_outliers(data_PSD$N2_PSD40_con, plot=FALSE)
```
Outliers (exp):  
```{r H2a outliers exp}
check_outliers(data_PSD$N2_PSD40_exp, plot=FALSE)
```

### Statistical test

```{r H2a}
H2a_results = test_two_levels(data_PSD$N2_PSD40_exp, data_PSD$N2_PSD40_con, parametric=TRUE, alternative="greater", verbose=FALSE)
```

Likewise, for stage N2, we postulated that on average, the PSD40 value would be higher in the experimental than in the control condition (H2a). A directed paired t-test confirmed this hypothesis 
(_p_ = `r format(H2a_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_cohens_d(H2a_results[[2]])`, 
with a Cohen’s _d~z~_ of `r round(H2a_results[[2]],2)` 
(CI = [`r round(H2a_results[[3]],2)` ; `r round(H2a_results[[4]],2)`]).

## H3a: N3~exp~ > N3~con~

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H3a normality}
check_normality(data_PSD$N3_PSD40_exp - data_PSD$N3_PSD40_con, plot=FALSE)
```
Outliers (con):  
```{r H3a outliers con}
check_outliers(data_PSD$N3_PSD40_con, plot=FALSE)
```
Outliers (exp):  
```{r H3a outliers exp}
check_outliers(data_PSD$N3_PSD40_exp, plot=FALSE)
```

### Statistical test

```{r H3a}
H3a_results = test_two_levels(data_PSD$N3_PSD40_exp, data_PSD$N3_PSD40_con, parametric=TRUE, alternative="greater", verbose=FALSE)
```

For stage N3, we also expected that on average, the PSD40 value would be higher in the experimental than in the control condition (H3a). A directed paired t-test confirmed this hypothesis 
(_p_ = `r format(H3a_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_cohens_d(H3a_results[[2]])`, 
with a Cohen’s _d~z~_ of `r round(H3a_results[[2]],2)` 
(CI = [`r round(H3a_results[[3]],2)` ; `r round(H3a_results[[4]],2)`]).

## H4a: REM~exp~ > REM~con~

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H4a normality}
check_normality(data_PSD$REM_PSD40_exp - data_PSD$REM_PSD40_con, plot=FALSE)
```
Outliers (con):  
```{r H4a outliers con}
check_outliers(data_PSD$REM_PSD40_con, plot=FALSE)
```
Outliers (exp):  
```{r H4a outliers exp}
check_outliers(data_PSD$REM_PSD40_exp, plot=FALSE)
```

### Statistical test

```{r H4a}
H4a_results = test_two_levels(data_PSD$REM_PSD40_exp, data_PSD$REM_PSD40_con, parametric=FALSE, alternative="greater", verbose=FALSE)
```

Analogously, for stage REM, we anticipated that on average, the PSD40 value would be higher in the experimental than in the control condition (H4a). A directed Wilcoxon signed rank test confirmed this hypothesis 
(_p_ = `r format(H4a_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_rank_biserial(H4a_results[[2]])`, 
with a rank biserial correlation _r_ of `r round(H4a_results[[2]],2)` 
(CI = [`r round(H4a_results[[3]],2)` ; `r round(H4a_results[[4]],2)`]).

```{r PSD Plot}
# Conversion to long format
data_PSD_dB_long = dataframe_wide_to_long(data_PSD[,c("ID","W_PSD40_con","N2_PSD40_con","N3_PSD40_con","REM_PSD40_con","W_PSD40_exp","N2_PSD40_exp","N3_PSD40_exp","REM_PSD40_exp")])

ggplot(data_PSD_dB_long, aes(x=factor(stage, levels=c("W","N2","N3","REM")), y=value, fill=condition)) +
  geom_boxplot() + # Show condition pairs per stage
  geom_label(aes(x=stage, y=-147, label=condition), position=position_dodge(0.75), label.size=NA, alpha=0, colour="#818589") +
  geom_point(size=1, position=position_dodge(0.75)) + # add individual data points
  stat_summary(fun = "mean", geom = "point", size = 2, color = "white", position = position_dodge(0.75)) + # add mean
  scale_fill_manual(values=c(colour_scheme$con,colour_scheme$exp)) +
  labs(title="40 Hz Power", x="Stage", y="Power (dB)", fill="Condition") + # Labels
  theme_minimal(base_size = base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text.x = element_text(size=rel(1.7), face="bold"),
        axis.text.y = element_text(size=rel(1.7)),
        legend.position = 'none',
        panel.grid.major.x = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Figure: Spectral power at 40 Hz across sleep stages. dB values closer to zero indicate higher spectral power. White dots mark mean values._

## H5a: W~exp~ =/= N2~exp~ =/= N3~exp~ =/= REM~exp~

### Parametric test assumptions

Normality of scores (W~exp~):  
```{r H5a normality W}
check_normality(data_PSD$W_PSD40_exp, plot=FALSE)
```
Normality of scores (N2~exp~):  
```{r H5a normality N2}
check_normality(data_PSD$N2_PSD40_exp, plot=FALSE)
```
Normality of scores (N3~exp~):  
```{r H5a normality N3}
check_normality(data_PSD$N3_PSD40_exp, plot=FALSE)
```
Normality of scores (REM~exp~):  
```{r H5a normality REM}
check_normality(data_PSD$REM_PSD40_exp, plot=FALSE)
```
Outliers (W~exp~):  
```{r H5a outliers W}
check_outliers(data_PSD$W_PSD40_exp, plot=FALSE)
```
Outliers (N2~exp~):  
```{r H5a outliers N2}
check_outliers(data_PSD$N2_PSD40_exp, plot=FALSE)
```
Outliers (N3~exp~):  
```{r H5a outliers N3}
check_outliers(data_PSD$N3_PSD40_exp, plot=FALSE)
```
Outliers (REM~exp~):  
```{r H5a outliers REM}
check_outliers(data_PSD$REM_PSD40_exp, plot=FALSE)
```
Sphericity:
```{r H5a sphericity}
check_sphericity(data_PSD[,c("W_PSD40_exp","N2_PSD40_exp","N3_PSD40_exp","REM_PSD40_exp")])
```

### Statistical test

```{r H5a}
# Get data subset
data_anova_PSD_dB = subset(data_PSD_dB_long, condition=="exp", select=c(ID,stage,value))

# Run statistical test
H5a_results = test_multiple_levels(data_anova_PSD_dB, parametric=TRUE, sphericity_correction="greenhouse-geisser", verbose=FALSE)
```

Additionally, in the experimental condition, 40 Hz power was expected to differ between stages (H5a). A repeated measures ANOVA, Greenhouse-Geisser-corrected for sphericity deviations, confirmed this hypothesis 
(_p_ = `r format(H5a_results[[1]], scientific=TRUE, digits=3)`).
The effect size was `r interpret_eta_squared(H5a_results[[2]])`, 
with an eta squared of `r round(H5a_results[[2]],2)` 
(CI = [`r round(H5a_results[[3]],2)` ; `r round(H5a_results[[4]],2)`]).
However, post-hoc tests reveal that only stage W differs from all other stages, with no significant differences between the sleep stages N2, N3, and REM 
(_p~W-N2~_ = `r format(H5a_results[[5]]["W","N2"], scientific=TRUE, digits=3)`,
_p~W-N3~_ = `r format(H5a_results[[5]]["W","N3"], scientific=TRUE, digits=3)`,
_p~W-REM~_ = `r format(H5a_results[[5]]["W","REM"], scientific=TRUE, digits=3)`,
all other _p_ = `r round(H5a_results[[5]]["N3","N2"], 2)`). 
We can conclude that 40 Hz power during stimulation is largest in W, and similarly large between sleep stages.

## Signal-to-Noise Ratio (SNR-PSD40)

Consistent with confirmatory analyses, all SNR values in the control condition are close to 1, and all SNR values in the experimental condition are higher than 1, with a markedly higher value in W~exp~. 

```{r SNR PSD medians}
# Conversion to long format
data_PSD_SNR_long = dataframe_wide_to_long(data_PSD[,c("ID","W_SNR40_con","N2_SNR40_con","N3_SNR40_con","REM_SNR40_con","W_SNR40_exp","N2_SNR40_exp","N3_SNR40_exp","REM_SNR40_exp")])

# Median SNR values per condition
medians_PSD_SNR = aggregate(value ~ stage * condition, data_PSD_SNR_long, median) # mean likely biased by outliers
print(medians_PSD_SNR, row.names=FALSE)

ggplot(medians_PSD_SNR, aes(x=condition,y=stage,fill=value)) +
  geom_tile(color = "white",lwd = 1.5) +
  geom_text(aes(label=round(value, 2)), color = "white", size = 4, fontface="bold") +
  scale_fill_gradient(low="grey", high="#6082B6") +
  labs(title="SNR of 40 Hz Power", x="Condition", y="Stage") + # Labels
  coord_fixed(ratio=0.8) +
  theme_minimal(base_size = base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)),
        legend.position = 'none',
        panel.grid = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins

```

_Table: Median SNR values for PSD40. Medians were chosen over means due to outliers._

# Secondary Analyses (Sleep Quality)

## Subjective Sleep Quality

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H6 normality}
check_normality(data_sleep$GSQS_exp - data_sleep$GSQS_con, plot=FALSE)
```
Outliers (con):  
```{r H6 outliers con}
check_outliers(data_sleep$GSQS_con, plot=FALSE)
```
Outliers (exp):  
```{r H6 outliers exp}
check_outliers(data_sleep$GSQS_exp, plot=FALSE)
```

### Statistical test

```{r H6}
H6_results = test_two_levels(data_sleep$GSQS_con, data_sleep$GSQS_exp, parametric=TRUE, alternative="two.sided", verbose=FALSE)
```

Regarding subjective sleep quality quantified as the GSQS sum score, we postulated that it would differ between the control
and experimental condition. An undirected paired t-test confirmed this hypothesis (_p_ = `r round(H6_results[[1]], 2)`), indicating that sleep quality was perceived to be higher in the experimental (Mean~exp~ = `r round(mean(data_sleep$GSQS_exp),2)`, SD~exp~ = `r round(sd(data_sleep$GSQS_exp),2)`)
than in the control (Mean~con~ = `r round(mean(data_sleep$GSQS_con),2)`, SD~con~ = `r round(sd(data_sleep$GSQS_con),2)`)
night. 
The effect size was `r interpret_cohens_d(H6_results[[2]])`, 
with a Cohen’s _d~z~_ of `r round(H6_results[[2]],2)` 
(CI = [`r round(H6_results[[3]],2)` ; `r round(H6_results[[4]],2)`]).  

```{r GSQS plot}
# Conversion to long format
data_GSQS_long = dataframe_wide_to_long(data_sleep[,c("ID","GSQS_con","GSQS_exp")])

ggplot(data_GSQS_long, aes(x=condition, y=value)) + 
  geom_violinhalf(aes(fill=condition), flip=1) + # Violin plot shape
  geom_point(color="grey", size=2) + # Data points, jittered
  geom_line(aes(group = ID), color="grey", linewidth=0.5) + # connect paired dots
  stat_summary(fun = "mean", geom="point", shape=18, color = "black", size=5) + # Add mean as point
  labs(title="Groningen Sleep Quality Scale", x="Condition", y="GSQS Sum Score") + # Labels
  scale_fill_manual(values=c(colour_scheme$con, colour_scheme$exp), guide="none") + # Condition colours, remove legend
  scale_x_discrete(labels=c("Control","Experimental")) + # X-tick labels
  coord_fixed(ratio=0.15) +
  theme_minimal(base_size=base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)), 
        panel.grid.major = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Figure: Distribution of GSQS sum scores. Lower scores indicate better sleep quality. Dashed lines connect values for the control and experimental night, per participant. Black squares mark mean values._

## Total Sleep Time

### Parametric test assumptions

Normality of difference scores (exp - con):  
```{r H7 normality}
check_normality(data_sleep$TST_exp - data_sleep$TST_con, plot=FALSE)
```
Outliers (con):  
```{r H7 outliers con}
check_outliers(data_sleep$TST_con, plot=FALSE)
```
Outliers (exp):  
```{r H7 outliers exp}
check_outliers(data_sleep$TST_exp, plot=FALSE)
```

### Statistical test

```{r H7}
H7_results = test_two_levels(data_sleep$TST_exp, data_sleep$TST_con, parametric=TRUE, alternative="two.sided", verbose=FALSE)
```

For TST as a marker of objective sleep quality, we also hypothesized that it would differ between the control
and experimental condition. An undirected paired t-test rejected this hypothesis (_p_ = `r round(H7_results[[1]], 2)`), showing that on average, participants slept for a similarly long time in both the experimental (Mean~exp~ = `r round(mean(data_sleep$TST_exp),2)` min, SD~exp~ = `r round(sd(data_sleep$TST_exp),2)` min)
and the control (Mean~con~ = `r round(mean(data_sleep$TST_con),2)` min, SD~con~ = `r round(sd(data_sleep$TST_con),2)` min)
nights.  

```{r TST plot}
# Conversion to long format
data_TST_long = dataframe_wide_to_long(data_sleep[,c("ID","TST_con","TST_exp")])

# Plot
ggplot(data_TST_long, aes(x=condition, y=value)) + 
  geom_violinhalf(aes(fill=condition), flip=1) + # Violin plot shape
  geom_point(color="grey", size=2) + # Data points, jittered
  geom_line(aes(group = ID), color="grey", linewidth=0.5) + # connect paired dots
  stat_summary(fun = "mean", geom="point", shape=18, color = "black", size=5) + # Add mean as point
  labs(title="Total Sleep Time", x="Condition", y="Minutes") + # Labels
  scale_fill_manual(values=c(colour_scheme$con, colour_scheme$exp), guide="none") + # Condition colours, remove legend
  scale_x_discrete(labels=c("Control","Experimental")) + # X-tick labels
  scale_y_continuous(limits=c(315,460),breaks=c(320,390,460)) +
  coord_fixed(ratio=0.015) +
  theme_minimal(base_size=base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)), 
        panel.grid.major.x = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Figure: Distribution of Total Sleep Times per condition. Dashed lines connect values for the control and experimental night, per participant. Black squares mark mean values._

## Wake After Sleep Onset

### Parametric test assumptions

Normality of difference scores (exp - con):  
```{r H8 normality}
check_normality(data_sleep$WASO_exp - data_sleep$WASO_con, plot=FALSE)
```
Outliers (con):  
```{r H8 outliers con}
check_outliers(data_sleep$WASO_con, plot=FALSE)
```
Outliers (exp):  
```{r H8 outliers exp}
check_outliers(data_sleep$WASO_exp, plot=FALSE)
```

### Statistical test

```{r H8}
H8_results = test_two_levels(data_sleep$WASO_exp, data_sleep$WASO_con, parametric=TRUE, alternative="two.sided", verbose=FALSE)
```

For WASO as another marker of objective sleep quality, we also expected that it would differ between the control
and experimental condition. An undirected paired t-test rejected this hypothesis (_p_ = `r round(H8_results[[1]], 2)`), implying that on average, participants spent a similar amount of time awake overnight in both the experimental (Mean~exp~ = `r round(mean(data_sleep$WASO_exp),2)` min, SD~exp~ = `r round(sd(data_sleep$WASO_exp),2)` min)
and the control (Mean~con~ = `r round(mean(data_sleep$WASO_con),2)` min, SD~con~ = `r round(sd(data_sleep$WASO_con),2)` min)
nights.  

```{r WASO plot}
# Conversion to long format
data_WASO_long = dataframe_wide_to_long(data_sleep[,c("ID","WASO_con","WASO_exp")])

# Plot
ggplot(data_WASO_long, aes(x=condition, y=value)) + 
  geom_violinhalf(aes(fill=condition), flip=1) + # Violin plot shape
  geom_point(color="grey", size=2) + # Data points, jittered
  geom_line(aes(group = ID), color="grey", linewidth=0.5) + # connect paired dots
  stat_summary(fun = "mean", geom="point", shape=18, color = "black", size=5) + # Add mean as point
  labs(title="Wake After Sleep Onset", x="Condition", y="Minutes") + # Labels
  scale_fill_manual(values=c(colour_scheme$con, colour_scheme$exp), guide="none") + # Condition colours, remove legend
  scale_x_discrete(labels=c("Control","Experimental")) + # X-tick labels
  scale_y_continuous(limits=c(10,140),breaks=c(10,70,130)) +
  coord_fixed(ratio=0.015) +
  theme_minimal(base_size=base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)), 
        panel.grid.major.x = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Figure: Distribution of total Wake After Sleep Onset times per condition. Dashed lines connect values for the control and experimental night, per participant. Black squares mark mean values._

## Time per Stage

Lastly, Time per Stage descriptively points to a sleep stage distribution common in healthy, young sleepers. Both nights are very similar, with lowest values for 
N1 (Mean~con~ = `r round(mean(data_sleep$perN1_con),2)` %, Mean~exp~ = `r round(mean(data_sleep$perN1_exp),2)` %), 
highest values for N2 (Mean~con~ = `r round(mean(data_sleep$perN2_con),2)` %, Mean~exp~ = `r round(mean(data_sleep$perN2_exp),2)` %), 
and both N3 (Mean~con~ = `r round(mean(data_sleep$perN3_con),2)` %, Mean~exp~ = `r round(mean(data_sleep$perN3_exp),2)` %) 
and REM (Mean~con~ = `r round(mean(data_sleep$perREM_con),2)` %, Mean~exp~ = `r round(mean(data_sleep$perREM_exp),2)` %) in-between.  
```{r Time per Stage plot}
# Conversion to long format
data_percent_stages_long = dataframe_wide_to_long(data_sleep[,c("ID","perN1_con","perN2_con","perN3_con","perREM_con","perN1_exp","perN2_exp","perN3_exp","perREM_exp")])

# Stacked bar graph of % time per stage
ggplot(data_percent_stages_long, aes(x=condition, y=value, fill=variable)) +
  geom_bar(stat="identity", position = position_fill(reverse = TRUE), width=0.5) + # Start with N1
  labs(title="Sleep Stage Distribution", x="", y="Time per Stage (% of TST)", fill="Stage") + # Labels
  annotate(geom="text", x=0.85, y=0.025, label="N1", colour="white", fontface="bold") +
  annotate(geom="text", x=0.85, y=0.11, label="N2", colour="white", fontface="bold") +
  annotate(geom="text", x=0.85, y=0.645, label="N3", colour="white", fontface="bold") +
  annotate(geom="text", x=0.85, y=0.835, label="REM", colour="white", fontface="bold") +
  scale_x_discrete(labels=c("Control","Experimental")) + # X-tick labels
  scale_fill_manual(values=c(colour_scheme$N1, colour_scheme$N2, colour_scheme$N3, colour_scheme$REM), labels=c("N1","N2","N3","REM")) + # Stage colours & labels
  scale_y_continuous(labels = percent) + # Y-tick values
  theme_minimal(base_size = base_size) + # Background
  coord_flip() + # Flip x & y axes
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.text.x = element_text(size=rel(1.7)), 
        axis.text.y = element_text(size=rel(1.7), face="bold"), 
        plot.title = element_text(size=rel(3)),
        legend.position = 'none',
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Figure: Average time spent in each stage, as a percentage of the total time asleep, across participants._

# Secondary Analyses (SSVEPamp)

## Descriptive

```{r Descriptive Table SSVEPamp}
# Initialize
descriptive_SSVEPamp = data.frame(Median_uV_con=rep(NA,4),
                               Median_uV_exp=rep(NA,4),
                               IQR_uV_con=rep(NA,4),
                               IQR_uV_exp=rep(NA,4),
                               Mean_nr_segments_con=rep(NA,4),
                               Mean_nr_segments_exp=rep(NA,4))
stages = c("W","N2","N3","REM")
row.names(descriptive_SSVEPamp) = stages

# Fill 
ctr_con = 3 # counter starting at column 3 of data_SSVEP
ctr_exp = 15 # counter starting at column 15 of data_SSVEP

for (s in stages) {

  descriptive_SSVEPamp[s,"Median_uV_con"] = round(median(data_SSVEP[,ctr_con]),2)
  descriptive_SSVEPamp[s,"Median_uV_exp"] = round(median(data_SSVEP[,ctr_exp]),2)
  descriptive_SSVEPamp[s,"IQR_uV_con"] = round(IQR(data_SSVEP[,ctr_con]),2)
  descriptive_SSVEPamp[s,"IQR_uV_exp"] = round(IQR(data_SSVEP[,ctr_exp]),2)
  descriptive_SSVEPamp[s,"Mean_nr_segments_con"] = round(mean(data_SSVEP[,ctr_con-1]),2)
  descriptive_SSVEPamp[s,"Mean_nr_segments_exp"] = round(mean(data_SSVEP[,ctr_exp-1]),2)
  
  ctr_con = ctr_con+3
  ctr_exp = ctr_exp+3
  
}

print(descriptive_SSVEPamp)
```

_Table: Descriptive statistics for SSVEPamp across all stages and conditions. Means and standard deviations for SSVEPamp in uV; average number of 25 ms segments factoring into analyses._

## H1b: W~exp~ > W~con~ 

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H1b normality}
check_normality(data_SSVEP$W_PTA_exp - data_SSVEP$W_PTA_con, plot=FALSE)
```
Outliers (con):  
```{r H1b outliers con}
check_outliers(data_SSVEP$W_PTA_con, plot=FALSE)
```
Outliers (exp):  
```{r H1b outliers exp}
check_outliers(data_SSVEP$W_PTA_exp, plot=FALSE)
```

### Statistical test

```{r H1b}
H1b_results = test_two_levels(data_SSVEP$W_PTA_exp, data_SSVEP$W_PTA_con, parametric=FALSE, alternative="greater", verbose=FALSE)
```

For stage W, we postulated that on average, the SSVEPamp value would be higher in the experimental than in the control condition (H1b). A directed Wilcoxon signed rank test confirmed this hypothesis 
(_p_ = `r format(H1b_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_rank_biserial(H1b_results[[2]])`, 
with a rank biserial correlation _r_ of `r round(H1b_results[[2]],2)` 
(CI = [`r round(H1b_results[[3]],2)` ; `r round(H1b_results[[4]],2)`]).  
```{r SSVEP W plot}


```

## H2b: N2~exp~ > N2~con~ 

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H2b normality}
check_normality(data_SSVEP$N2_PTA_exp - data_SSVEP$N2_PTA_con, plot=FALSE)
```
Outliers (con):  
```{r H2b outliers con}
check_outliers(data_SSVEP$N2_PTA_con, plot=FALSE)
```
Outliers (exp):  
```{r H2b outliers exp}
check_outliers(data_SSVEP$N2_PTA_exp, plot=FALSE)
```

### Statistical test

```{r H2b}
H2b_results = test_two_levels(data_SSVEP$N2_PTA_exp, data_SSVEP$N2_PTA_con, parametric=FALSE, alternative="greater", verbose=FALSE)
```

For stage N2, we also hypothesized that on average, the SSVEPamp value would be higher in the experimental than in the control condition (H2b). A directed Wilcoxon signed rank test confirmed this hypothesis 
(_p_ = `r format(H2b_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_rank_biserial(H2b_results[[2]])`, 
with a rank biserial correlation _r_ of `r round(H2b_results[[2]],2)` 
(CI = [`r round(H2b_results[[3]],2)` ; `r round(H2b_results[[4]],2)`]).  

## H3b: N3~exp~ > N3~con~ 

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H3b normality}
check_normality(data_SSVEP$N3_PTA_exp - data_SSVEP$N3_PTA_con, plot=FALSE)
```
Outliers (con):  
```{r H3b outliers con}
check_outliers(data_SSVEP$N3_PTA_con, plot=FALSE)
```
Outliers (exp):  
```{r H3b outliers exp}
check_outliers(data_SSVEP$N3_PTA_exp, plot=FALSE)
```

### Statistical test

```{r H3b}
H3b_results = test_two_levels(data_SSVEP$N3_PTA_exp, data_SSVEP$N3_PTA_con, parametric=TRUE, alternative="greater", verbose=FALSE)
```

For stage N3, we equally expected that on average, the SSVEPamp value would be higher in the experimental than in the control condition (H3b). A directed paired t-test confirmed this hypothesis 
(_p_ = `r format(H3b_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_cohens_d(H3b_results[[2]])`, 
with a Cohen’s _d~z~_ of `r round(H3b_results[[2]],2)` 
(CI = [`r round(H3b_results[[3]],2)` ; `r round(H3b_results[[4]],2)`]).  

## H4b: REM~exp~ > REM~con~ 

### Parametric test assumptions  

Normality of difference scores (exp - con):  
```{r H4b normality}
check_normality(data_SSVEP$REM_PTA_exp - data_SSVEP$REM_PTA_con, plot=FALSE)
```
Outliers (con):  
```{r H4b outliers con}
check_outliers(data_SSVEP$REM_PTA_con, plot=FALSE)
```
Outliers (exp):  
```{r H4b outliers exp}
check_outliers(data_SSVEP$REM_PTA_exp, plot=FALSE)
```

### Statistical test

```{r H4b}
H4b_results = test_two_levels(data_SSVEP$REM_PTA_exp, data_SSVEP$REM_PTA_con, parametric=FALSE, alternative="greater", verbose=FALSE)
```

For stage REM as well, we anticipated that on average, the SSVEPamp value would be higher in the experimental than in the control condition (H4b). A directed Wilcoxon signed rank test confirmed this hypothesis 
(_p_ = `r format(H4b_results[[1]], scientific=TRUE, digits=3)`). 
The effect size was `r interpret_rank_biserial(H4b_results[[2]])`, 
with a rank biserial correlation _r_ of `r round(H4b_results[[2]],2)` 
(CI = [`r round(H4b_results[[3]],2)` ; `r round(H4b_results[[4]],2)`]).  

## H5b: W~exp~ =/= N2~exp~ =/= N3~exp~ =/= REM~exp~

### Parametric test assumptions

Normality of scores (W~exp~):  
```{r H5b normality W}
check_normality(data_SSVEP$W_PTA_exp, plot=FALSE)
```
Normality of scores (N2~exp~):  
```{r H5b normality N2}
check_normality(data_SSVEP$N2_PTA_exp, plot=FALSE)
```
Normality of scores (N3~exp~):  
```{r H5b normality N3}
check_normality(data_SSVEP$N3_PTA_exp, plot=FALSE)
```
Normality of scores (REM~exp~):  
```{r H5b normality REM}
check_normality(data_SSVEP$REM_PTA_exp, plot=FALSE)
```
Outliers (W~exp~):  
```{r H5b outliers W}
check_outliers(data_SSVEP$W_PTA_exp, plot=FALSE)
```
Outliers (N2~exp~):  
```{r H5b outliers N2}
check_outliers(data_SSVEP$N2_PTA_exp, plot=FALSE)
```
Outliers (N3~exp~):  
```{r H5b outliers N3}
check_outliers(data_SSVEP$N3_PTA_exp, plot=FALSE)
```
Outliers (REM~exp~):  
```{r H5b outliers REM}
check_outliers(data_SSVEP$REM_PTA_exp, plot=FALSE)
```
Sphericity:
```{r H5b sphericity}
check_sphericity(data_SSVEP[,c("W_PTA_exp","N2_PTA_exp","N3_PTA_exp","REM_PTA_exp")])
```

### Statistical test

```{r H5b}
# Conversion to long format
data_SSVEP_uV_long = dataframe_wide_to_long(data_SSVEP[,c("ID","W_PTA_con","N2_PTA_con","N3_PTA_con","REM_PTA_con","W_PTA_exp","N2_PTA_exp","N3_PTA_exp","REM_PTA_exp")])

# Get data subset
data_anova_SSVEP_uV = subset(data_SSVEP_uV_long, condition=="exp", select=c(ID,stage,value))

# Run statistical test
H5b_results = test_multiple_levels(data_anova_SSVEP_uV, parametric=FALSE, sphericity_correction="none", verbose=FALSE)
```

Additionally, in the experimental condition, SSVEP amplitude was expected to differ between stages (H5b). A Friedman ANOVA confirmed this hypothesis 
(_p_ = `r format(H5b_results[[1]], scientific=TRUE, digits=3)`).
A Kendall's _w_ of `r round(H5b_results[[2]],2)` 
(CI = [`r round(H5b_results[[3]],2)` ; `r round(H5b_results[[4]],2)`]) indicates "`r interpret_kendalls_w(H5b_results[[2]])`".
However, post-hoc tests reveal that only stage W differs from all other stages, with no significant difference between the sleep stages N2, N3, and REM 
(_p~W-N2~_ = `r format(H5b_results[[5]]["W","N2"], scientific=TRUE, digits=3)`,
_p~W-N3~_ = `r format(H5b_results[[5]]["W","N3"], scientific=TRUE, digits=3)`,
_p~W-REM~_ = `r format(H5b_results[[5]]["W","REM"], scientific=TRUE, digits=3)`,
all other _p_ = `r round(H5b_results[[5]]["N3","N2"], 2)`). 
We can conclude that SSVEP amplitude during stimulation is largest in W, and similarly large between sleep stages. 

## Signal-to-Noise Ratio (SNR-SSVEPamp)

The median SNR values are displayed in this table. Consistent with secondary analyses, all SNR values in the control condition are close to 1, and all SNR values in the experimental condition are higher than 1, with a markedly higher value in W~exp~. 

```{r SNR SSVEP medians}
# Conversion to long format
data_SSVEP_SNR_long = dataframe_wide_to_long(data_SSVEP[,c("ID","W_SNR_con","N2_SNR_con","N3_SNR_con","REM_SNR_con","W_SNR_exp","N2_SNR_exp","N3_SNR_exp","REM_SNR_exp")])

# Median SNR values per condition
medians_SSVEP_SNR = aggregate(value ~ stage * condition, data_SSVEP_SNR_long, median) # mean likely biased by outliers
print(medians_SSVEP_SNR, row.names=FALSE)

ggplot(medians_SSVEP_SNR, aes(x=condition,y=stage,fill=value)) +
  geom_tile(color = "white",lwd = 1.5) +
  geom_text(aes(label=round(value, 2)), color = "white", size = 4, fontface="bold") +
  scale_fill_gradient(low="grey", high="#6082B6") +
  labs(title="SNR of SSVEPs", x="Condition", y="Stage") + # Labels
  coord_fixed(ratio=0.8) +
  theme_minimal(base_size = base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)),
        legend.position = 'none',
        panel.grid = element_blank(),
        plot.title = element_text(size=rel(3)),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Table: Median SNR values for SSVEPamp. Medians were chosen over means due to outliers._

## Time Series Plots

```{r SSVEP avg}
# All SSVEP time series data in long format
timeseries_SSVEPs = import_SSVEPs_to_long_dataframe()

# Collapse data over subjects
data_SSVEPs_avg = timeseries_SSVEPs %>% group_by(time,stage,condition) %>% summarise_at(vars("value"), mean)
```
  
```{r SSVEP avg W}
ggplot(data_SSVEPs_avg[data_SSVEPs_avg$stage=="W",], aes(x=time, y=value, color=condition)) +
  geom_line(linewidth=1.5) +
  facet_wrap(~factor(stage), strip.position = "bottom") + 
  labs(title="Average SSVEPs", y="Amplitude (uV)", x="Time (ms)") +
  scale_x_continuous(limits=c(0,25), breaks=c(0,12.5,25)) +
  scale_color_manual(name="Condition", values=c(colour_scheme$con,colour_scheme$W), labels=c("Control","Experimental")) +
  ylim(-0.4,0.4) +
  theme_minimal(base_size=base_size) +
  theme(panel.grid.minor = element_blank(), # remove background lines
        strip.text.x = element_text(size=rel(2), face="bold"),
        axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=1.5),
        axis.text = element_text(size=rel(1.7)), 
        legend.position = 'none',
        plot.title = element_text(size=rel(3), vjust=1.5),
        plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
```
  
_Figure: SSVEPs averaged across all subjects by condition, in wakefulness._
  
```{r SSVEP avg Sleep}
ggplot(data_SSVEPs_avg[data_SSVEPs_avg$stage!="W",], aes(x=time, y=value, color=condition)) +
  geom_line(linewidth=1.5) +
  facet_wrap(~factor(stage), strip.position = "bottom") +  
  labs(title="Average SSVEPs", y="Amplitude (uV)", x="Time (ms)") +
  scale_x_continuous(limits=c(0,25), breaks=c(0,12.5,25)) +
  scale_color_manual(name="Condition", values=c(colour_scheme$con,colour_scheme$exp), labels=c("Control","Experimental")) +
  ylim(-0.05,0.05) +
  theme_minimal(base_size=base_size) +
  theme(panel.grid.minor = element_blank(), # remove background lines
        strip.text.x = element_text(size=rel(2), face="bold"),
        axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=1.5),
        axis.text = element_text(size=rel(1.7)), 
        legend.text = element_text(size=rel(1.7)),
        legend.title = element_text(size=rel(1.7)),
        plot.title = element_text(size=rel(3), vjust=1.5),
        plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
```
  
_Figure: SSVEPs averaged across all subjects by condition, in the three sleep stages._

# Extra Analyses

## Correlations: Nr. of Epochs x PSD40

_Post-hoc_, Pearson correlations were computed between the number of epochs stimulated and PSD40, in the experimental condition, stratified by sleep stage. Overall, correlations are small (positive for N2 and N3, negative for REM).  
  
_r~N2~_ = `r round(cor(data_PSD$N2_nepochs_exp, data_PSD$N2_PSD40_exp),2)`  
_r~N3~_ = `r round(cor(data_PSD$N3_nepochs_exp, data_PSD$N3_PSD40_exp),2)`  
_r~REM~_ = `r round(cor(data_PSD$REM_nepochs_exp, data_PSD$REM_PSD40_exp),2)`  


## REM Latency

### Parametric test assumptions

Normality of difference scores (exp - con):  
```{r REM_lat normality}
check_normality(data_sleep$REM_lat_exp - data_sleep$REM_lat_con, plot=FALSE)
```
Outliers (con):  
```{r REM_lat outliers con}
check_outliers(data_sleep$REM_lat_con, plot=FALSE)
```
Outliers (exp):  
```{r REM_lat outliers exp}
check_outliers(data_sleep$REM_lat_exp, plot=FALSE)
```

### Statistical test

```{r REM_lat}
REM_lat_results = test_two_levels(data_sleep$REM_lat_exp, data_sleep$REM_lat_con, parametric=TRUE, alternative="two.sided", verbose=FALSE)
```

REM latency was inspected post-hoc. An undirected paired t-test was significant (_p_ = `r round(REM_lat_results[[1]], 2)`), showing that on average, participants had a shorter REM sleep latency in the experimental condition (Mean~exp~ = `r round(mean(data_sleep$REM_lat_exp, na.rm=TRUE),2)` min, SD~exp~ = `r round(sd(data_sleep$REM_lat_exp, na.rm=TRUE),2)` min) than in the control condition (Mean~con~ = `r round(mean(data_sleep$REM_lat_con, na.rm=TRUE),2)` min, SD~con~ = `r round(sd(data_sleep$REM_lat_con, na.rm=TRUE),2)` min).  

```{r REM_lat plot}
# Conversion to long format
data_REM_lat_long = dataframe_wide_to_long(data_sleep[2:30,c("ID","REM_lat_con","REM_lat_exp")]) # excluding participant 1, NA

# Plot
ggplot(data_REM_lat_long, aes(x=condition, y=value)) + 
  geom_violinhalf(aes(fill=condition), flip=1) + # Violin plot shape
  geom_point(color="grey", size=2) + # Data points, jittered
  geom_line(aes(group = ID), color="grey", linewidth=0.5) + # connect paired dots
  stat_summary(fun = "mean", geom="point", shape=18, color = "black", size=5) + # Add mean as point
  labs(title="REM Sleep Latency", x="Condition", y="Minutes") + # Labels
  scale_fill_manual(values=c(colour_scheme$con, colour_scheme$exp), guide="none") + # Condition colours, remove legend
  scale_x_discrete(labels=c("Control","Experimental")) + # X-tick labels
  # scale_y_continuous(limits=c(315,460),breaks=c(320,390,460)) +
  coord_fixed(ratio=0.015) +
  theme_minimal(base_size=base_size) + # Background
  theme(axis.title.x = element_text(size=rel(2), vjust=-1), # Label sizes, relative
        axis.title.y = element_text(size=rel(2), vjust=2),
        axis.text = element_text(size=rel(1.7)), 
        panel.grid.major.x = element_blank(),
        plot.title = element_text(size=rel(3), hjust=0.7),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

_Figure: Distribution of REM sleep latencies per condition. Dashed lines connect values for the control and experimental night, per participant. Black squares mark mean values._


## REMs

```{r REMs}
REMs_long = dataframe_wide_to_long(data_sleep_extra[,c("ID","REMs_count_con","REMs_amplitude_con","REMs_density_con","REMs_count_exp","REMs_amplitude_exp","REMs_density_exp")])

# Median SNR values per condition
medians_REMs = aggregate(value ~ variable * condition, REMs_long, median) # mean likely biased by outliers

ggplot(medians_REMs, aes(x=condition,y=variable,fill=value)) +
  geom_tile(color = "white",lwd = 1.5) +
  geom_text(aes(label=round(value, 2)), color = "white", size = 5, fontface="bold") +
  scale_fill_gradient(low="grey", high="#6082B6") +
  labs(title="Rapid-Eye Movements", x="", y="") + # Labels
  scale_x_discrete(labels=c("Control","Experimental")) + # x-axis tick labels
  coord_fixed(ratio=1) +
  theme_minimal(base_size = base_size) + # Background
  theme(axis.text = element_text(size=rel(1.7)),
        legend.position = 'none',
        panel.grid = element_blank(),
        plot.title = element_text(size=rel(3), hjust=-0.2),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

## Spindles

```{r Spindles}
spindles_long = dataframe_wide_to_long(data_sleep_extra[,c("ID","Spindles_count_con","Spindles_amplitude_con","Spindles_frequency_con","Spindles_count_exp","Spindles_amplitude_exp","Spindles_frequency_exp")])

# Median SNR values per condition
medians_spindles = aggregate(value ~ variable * condition, spindles_long, median) # mean likely biased by outliers

ggplot(medians_spindles, aes(x=condition,y=variable,fill=value)) +
  geom_tile(color = "white",lwd = 1.5) +
  geom_text(aes(label=round(value, 2)), color = "white", size = 5, fontface="bold") +
  scale_fill_gradient(low="grey", high="#6082B6") +
  labs(title="Spindles", x="", y="") + # Labels
  scale_x_discrete(labels=c("Control","Experimental")) + # x-axis tick labels
  coord_fixed(ratio=1) +
  theme_minimal(base_size = base_size) + # Background
  theme(axis.text = element_text(size=rel(1.7)),
        legend.position = 'none',
        panel.grid = element_blank(),
        plot.title = element_text(size=rel(3), hjust=0.08),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```
### Post-hoc test: spindle count

```{r Spindle_count}
spindle_count_results = test_two_levels(data_sleep_extra$Spindles_count_exp, data_sleep_extra$Spindles_count_con, parametric=TRUE, alternative="two.sided", verbose=FALSE)
```

A post-hoc undirected paired t-test did not reveal significant differences in the amount of spindles in N2 and N3 between conditions (_p_ = `r round(spindle_count_results[[1]], 2)`). 

## SOs

```{r SOs}
SOs_long = dataframe_wide_to_long(data_sleep_extra[,c("ID","SOs_count_con","SOs_amplitude_con","SOs_frequency_con","SOs_count_exp","SOs_amplitude_exp","SOs_frequency_exp")])

# Median SNR values per condition
medians_SOs = aggregate(value ~ variable * condition, SOs_long, median) # mean likely biased by outliers

ggplot(medians_SOs, aes(x=condition,y=variable,fill=value)) +
  geom_tile(color = "white",lwd = 1.5) +
  geom_text(aes(label=round(value, 2)), color = "white", size = 5, fontface="bold") +
  scale_fill_gradient(low="grey", high="#6082B6") +
  labs(title="Slow Oscillations", x="", y="") + # Labels
  scale_x_discrete(labels=c("Control","Experimental")) + # x-axis tick labels
  coord_fixed(ratio=1) +
  theme_minimal(base_size = base_size) + # Background
  theme(axis.text = element_text(size=rel(1.7)),
        legend.position = 'none',
        panel.grid = element_blank(),
        plot.title = element_text(size=rel(3), hjust=0.6),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm")) # Plot margins
```

### Post-hoc test: slow oscillation count

```{r SOs_count}
SO_count_results = test_two_levels(data_sleep_extra$SOs_count_exp, data_sleep_extra$SOs_count_con, parametric=TRUE, alternative="two.sided", verbose=FALSE)
```

A post-hoc undirected paired t-test did not reveal significant differences in the amount of slow oscillations in N2 and N3 between conditions (_p_ = `r round(SO_count_results[[1]], 2)`).